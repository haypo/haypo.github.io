<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>Visualize the system noise using perf and CPU isolation</title>
        <link rel="stylesheet" href="https://vstinner.github.io/theme/css/main.css" />
        <link href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Victor Stinner blog 3 Atom Feed" />
        <meta name="description" content="I developed a new perf module designed to run stable benchmarks, give fine control on benchmark parameters and compute statistics on results. With..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://vstinner.github.io/">Victor Stinner blog 3</a></h1>
                <nav><ul>
                    <li class="active"><a href="https://vstinner.github.io/category/benchmark.html">benchmark</a></li>
                    <li><a href="https://vstinner.github.io/category/cpython.html">cpython</a></li>
                    <li><a href="https://vstinner.github.io/category/linux.html">linux</a></li>
                    <li><a href="https://vstinner.github.io/category/python.html">python</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://vstinner.github.io/perf-visualize-system-noise-with-cpu-isolation.html" rel="bookmark"
           title="Permalink to Visualize the system noise using perf and CPU isolation">Visualize the system noise using perf and CPU isolation</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-06-16T13:30:00+02:00">
                Published: jeu. 16 juin 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://vstinner.github.io/author/victor-stinner.html">Victor Stinner</a>
        </address>
<p>In <a href="https://vstinner.github.io/category/benchmark.html">benchmark</a>.</p>
<p>tags: <a href="https://vstinner.github.io/tag/benchmark.html">benchmark</a> </p>
</footer><!-- /.post-info -->      <p>I developed a new <a class="reference external" href="http://perf.readthedocs.io/">perf module</a> designed to run
stable benchmarks, give fine control on benchmark parameters and compute
statistics on results. With such tool, it becomes simple to <em>visualize</em>
sources of noise. The CPU isolation will be used to visualize the system noise.
Running a benchmark on isolated CPUs isolates it from the system noise.</p>
<div class="section" id="isolate-cpus">
<h2>Isolate CPUs</h2>
<p>My computer has 4 physical CPU cores. I isolated half of them using
<tt class="docutils literal">isolcpus=2,3</tt> parameter of the Linux kernel. I modified manually the command
line in GRUB to add this parameter.</p>
<p>Check that CPUs are isolated:</p>
<pre class="literal-block">
$ cat /sys/devices/system/cpu/isolated
2-3
</pre>
<p>The CPU supports HyperThreading, but I disabled it in the BIOS.</p>
</div>
<div class="section" id="run-a-benchmark">
<h2>Run a benchmark</h2>
<p>The <tt class="docutils literal">perf</tt> module automatically detects and uses isolated CPU cores. I will
use the <tt class="docutils literal"><span class="pre">--affinity=0,1</span></tt> option to force running the benchmark on the CPUs
which are not isolated.</p>
<p>Microbenchmark with and without CPU isolation:</p>
<pre class="literal-block">
$ python3 -m perf.timeit --json-file=timeit_isolcpus.json --verbose -s 'x=1; y=2' 'x+y'
Pin process to isolated CPUs: 2-3
.........................
Median +- std dev: 36.6 ns +- 0.1 ns (25 runs x 3 samples x 10^7 loops; 1 warmup)

$ python3 -m perf.timeit --affinity=0,1 --json-file=timeit_no_isolcpus.json --verbose -s 'x=1; y=2' 'x+y'
Pin process to CPUs: 0-1
.........................
Median +- std dev: 36.7 ns +- 1.3 ns (25 runs x 3 samples x 10^7 loops; 1 warmup)
</pre>
<p>My computer was not 100% idle, I was using it while the benchmarks were
running.</p>
<p>The median is almost the same (36.6 ns and 36.7 ns). The first major difference
is the standard deviation: it is much larger without CPU isolation: 0.1 ns =&gt;
1.3 ns (13x larger).</p>
<p>Just in case, check manually CPU affinity in metadata:</p>
<pre class="literal-block">
$ python3 -m perf show timeit_isolcpus.json --metadata | grep cpu
- cpu_affinity: 2-3 (isolated)
- cpu_count: 4
- cpu_model_name: Intel(R) Core(TM) i7-2600 CPU &#64; 3.40GHz

$ python3 -m perf show timeit_no_isolcpus.json --metadata | grep cpu_affinity
- cpu_affinity: 0-1
</pre>
</div>
<div class="section" id="statistics">
<h2>Statistics</h2>
<p>The <tt class="docutils literal">perf stats</tt> command computes statistics on the distribution of samples:</p>
<pre class="literal-block">
$ python3 -m perf stats timeit_isolcpus.json
Number of samples: 75

Minimum: 36.5 ns (-0.1%)
Median +- std dev: 36.6 ns +- 0.1 ns (36.5 ns .. 36.7 ns)
Maximum: 36.7 ns (+0.4%)

$ python3 -m perf stats timeit_no_isolcpus.json
Number of samples: 75

Minimum: 36.5 ns (-0.5%)
Median +- std dev: 36.7 ns +- 1.3 ns (35.4 ns .. 38.0 ns)
Maximum: 43.0 ns (+17.0%)
</pre>
<p>The minimum is the same. The second major difference is the maximum: it is much
larger without CPU isolation: 36.7 ns (+0.4%) =&gt; 43.0 ns (+17.0%).</p>
<p>The difference between the maximum and the median is 63x larger without CPU
isolation: 0.1 ns (<tt class="docutils literal">36.7 - 36.6</tt>) =&gt; 6.3 ns (<tt class="docutils literal">43.0 - 36.7</tt>).</p>
<p>Depending on the system load, a single sample of the microbenchmark is up to
17% slower (maximum of 43.0 ns with a median of 36.7 ns) without CPU isolation.
The difference is smaller with CPU isolation: only 0.4% slower (for the
maximum, and 0.1% faster for the minimum).</p>
</div>
<div class="section" id="histogram">
<h2>Histogram</h2>
<p>Another way to analyze the distribution of samples is to render an histogram:</p>
<pre class="literal-block">
$ python3 -m perf hist --bins=8 timeit_isolcpus.json timeit_no_isolcpus.json
[ timeit_isolcpus ]
36.1 ns: 75 ################################################
36.9 ns:  0 |
37.7 ns:  0 |
38.5 ns:  0 |
39.3 ns:  0 |
40.1 ns:  0 |
40.9 ns:  0 |
41.7 ns:  0 |
42.5 ns:  0 |

[ timeit_no_isolcpus ]
36.1 ns: 52 ################################################
36.9 ns: 13 ############
37.7 ns:  1 #
38.5 ns:  4 ####
39.3 ns:  2 ##
40.1 ns:  0 |
40.9 ns:  1 #
41.7 ns:  0 |
42.5 ns:  2 ##
</pre>
<p>I choose the number of bars to get a small histogram and to get all samples of
the first benchmark on the same bar. With 8 bars, each bar is a range of 0.8
ns.</p>
<p>The last major difference is the shape of these histogram. Without CPU
isolation, there is a &quot;long tail&quot; at the right of the median: <a class="reference external" href="https://en.wikipedia.org/wiki/Outlier">outliers</a> in the range [37.7 ns; 42.5 ns].
The outliers come from the &quot;noise&quot; caused by the multitasking system.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>The <tt class="docutils literal">perf</tt> module provides multiple tools to analyze the distribution of
benchmark samples. Three tools show a major difference without CPU isolation
compared to results with CPU isolation:</p>
<ul class="simple">
<li>Standard deviation: 13x larger without isolation</li>
<li>Maximum: difference to median 63x larger without isolation</li>
<li>Shape of the histogram: long tail at the right of the median</li>
</ul>
<p>It explains why CPU isolation helps to make benchmarks more stable.</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://vstinner.readthedocs.org/">Victor Stinner's Notes</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/VictorStinner">Follow @VictorStinner on Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>