<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>My journey to stable benchmark, part 1 (system)</title>
        <link rel="stylesheet" href="https://vstinner.github.io/theme/css/main.css" />
        <link href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Victor Stinner blog 3 Atom Feed" />
        <meta name="description" content="My journey to stable benchmark, part 1" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://vstinner.github.io/">Victor Stinner blog 3</a></h1>
                <nav><ul>
                    <li class="active"><a href="https://vstinner.github.io/category/benchmark.html">benchmark</a></li>
                    <li><a href="https://vstinner.github.io/category/cpython.html">cpython</a></li>
                    <li><a href="https://vstinner.github.io/category/linux.html">linux</a></li>
                    <li><a href="https://vstinner.github.io/category/python.html">python</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://vstinner.github.io/journey-to-stable-benchmark-system.html" rel="bookmark"
           title="Permalink to My journey to stable benchmark, part 1 (system)">My journey to stable benchmark, part 1 (system)</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-05-21T16:50:00+02:00">
                Published: sam. 21 mai 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://vstinner.github.io/author/victor-stinner.html">Victor Stinner</a>
        </address>
<p>In <a href="https://vstinner.github.io/category/benchmark.html">benchmark</a>.</p>
<p>tags: <a href="https://vstinner.github.io/tag/optimization.html">optimization</a> <a href="https://vstinner.github.io/tag/benchmark.html">benchmark</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="background">
<h2>Background</h2>
<p>In the CPython development, it became common to require the result of the
<a class="reference external" href="https://hg.python.org/benchmarks">CPython benchmark suite</a> (&quot;The Grand
Unified Python Benchmark Suite&quot;) to evaluate the effect of an optimization
patch. The minimum requirement is to not introduce performance regressions.</p>
<p>I used the CPython benchmark suite and I had many bad surprises when trying to
analyze (understand) results. A change expected to be faster makes some
benchmarks slower without any obvious reason. At least, the change is expected
to be faster on some specific benchmarks, but have no impact on the other
benchmarks. The slowdown is usually between 5% and 10% slower. I am not
confortable with any kind of slowdown.</p>
<p>Many benchmarks look unstable. The problem is to trust the overall report.
Some developers started to say that they learnt to ignore some benchmarks known
to be unstable.</p>
<p>It's not the first time that I am totally disappointed by microbenchmark
results, so I decided to analyze completely the issue and go as deep as
possible to really understand the problem.</p>
</div>
<div class="section" id="how-to-get-stable-benchmarks-on-a-busy-linux-system">
<h2>How to get stable benchmarks on a busy Linux system</h2>
<p>A common advice to get stable benchmark is to stay away the keyboard
(&quot;freeze!&quot;) and stop all other applications to only run one application, the
benchmark.</p>
<p>Well, I'm working on a single computer and the full CPython benchmark suite
take up to 2 hours in rigorous mode. I just cannot stop working during 2 hours
to wait for the result of the benchmark. I like running benchmarks locally. It
is convenient to run benchmarks on the same computer used to develop.</p>
<p>The goal here is to &quot;remove the noise of the system&quot;. Get the same result on a
busy system than an idle system. My simple <a class="reference external" href="https://github.com/vstinner/misc/blob/master/bin/system_load.py">system_load.py</a> program can be
used to increase the system load. For example, run <tt class="docutils literal">system_load.py 10</tt> in a
terminal to get at least a system load of 10 (busy system) and run the
benchmark in a different terminal. Use CTRL+c to stop <tt class="docutils literal">system_load.py</tt>.</p>
</div>
<div class="section" id="cpu-isolation">
<h2>CPU isolation</h2>
<p>In 2016, it is common to get a CPU with multiple physical cores. For example,
my Intel CPU has 4 physical cores and 8 logical cores thanks to
<a class="reference external" href="https://en.wikipedia.org/wiki/Hyper-threading">Hyper-Threading</a>. It is
possible to configure the Linux kernel to not schedule processes on some CPUs
using the &quot;CPU isolation&quot; feature. It is the <tt class="docutils literal">isolcpus</tt> parameter of the
Linux command line, the value is a list of CPUs. Example:</p>
<pre class="literal-block">
isolcpus=2,3,6,7
</pre>
<p>Check with:</p>
<pre class="literal-block">
$ cat /sys/devices/system/cpu/isolated
2-3,6-7
</pre>
<p>If you have Hyper-Threading, you must isolate the two logicial cores of each
isolated physical core. You can use the <tt class="docutils literal">lscpu <span class="pre">--all</span> <span class="pre">--extended</span></tt> command to
identify physical cores. Example:</p>
<pre class="literal-block">
$ lscpu -a -e
CPU NODE SOCKET CORE L1d:L1i:L2:L3 ONLINE MAXMHZ    MINMHZ
0   0    0      0    0:0:0:0       yes    5900,0000 1600,0000
1   0    0      1    1:1:1:0       yes    5900,0000 1600,0000
2   0    0      2    2:2:2:0       yes    5900,0000 1600,0000
3   0    0      3    3:3:3:0       yes    5900,0000 1600,0000
4   0    0      0    0:0:0:0       yes    5900,0000 1600,0000
5   0    0      1    1:1:1:0       yes    5900,0000 1600,0000
6   0    0      2    2:2:2:0       yes    5900,0000 1600,0000
7   0    0      3    3:3:3:0       yes    5900,0000 1600,0000
</pre>
<p>The physical core <tt class="docutils literal">0</tt> (CORE column) is made of two logical cores (CPU
column): <tt class="docutils literal">0</tt> and <tt class="docutils literal">4</tt>.</p>
</div>
<div class="section" id="nohz-mode">
<h2>NOHZ mode</h2>
<p>By default, the Linux kernel uses a scheduling-clock which interrupts the
running application <tt class="docutils literal">HZ</tt> times per second to run the scheduler. <tt class="docutils literal">HZ</tt> is
usually between 100 and 1000: time slice between 1 ms and 10 ms.</p>
<p>Linux supports a <a class="reference external" href="https://www.kernel.org/doc/Documentation/timers/NO_HZ.txt">NOHZ mode</a> which is able to
disable the scheduling-clock when the system is idle to reduce the power
consumption. Linux 3.10 introduces a <a class="reference external" href="https://lwn.net/Articles/549580/">full ticketless mode</a>, NOHZ full, which is able to disable the
scheduling-clock when only one application is running on a CPU.</p>
<p>NOHZ full is disabled by default. It can be enabled with the <tt class="docutils literal">nohz_full</tt>
parameter of the Linux command line, the value is a list of CPUs. Example:</p>
<pre class="literal-block">
nohz_full=2,3,6,7
</pre>
<p>Check with:</p>
<pre class="literal-block">
$ cat /sys/devices/system/cpu/nohz_full
2-3,6-7
</pre>
</div>
<div class="section" id="interrupts-irq">
<h2>Interrupts (IRQ)</h2>
<p>The Linux kernel can also be configured to not run <a class="reference external" href="https://en.wikipedia.org/wiki/Interrupt_request_%28PC_architecture%29">interruptions (IRQ)</a>
handlers on some CPUs using <tt class="docutils literal">/proc/irq/default_smp_affinity</tt> and
<tt class="docutils literal"><span class="pre">/proc/irq/&lt;number&gt;/smp_affinity</span></tt> files. The value is not a list of CPUs but
a bitmask.</p>
<p>The <tt class="docutils literal">/proc/interrupts</tt> file can be read to see the number of interruptions
per CPU.</p>
<p>Read the <a class="reference external" href="https://www.kernel.org/doc/Documentation/IRQ-affinity.txt">Linux SMP IRQ affinity</a> documentation.</p>
</div>
<div class="section" id="example-of-effect-of-cpu-isolation-on-a-microbenchmark">
<h2>Example of effect of CPU isolation on a microbenchmark</h2>
<p>Example with Linux parameters:</p>
<pre class="literal-block">
isolcpus=2,3,6,7 nohz_full=2,3,6,7
</pre>
<p>Microbenchmark on an idle system (without CPU isolation):</p>
<pre class="literal-block">
$ python3 -m timeit 'sum(range(10**7))'
10 loops, best of 3: 229 msec per loop
</pre>
<p>Result on a busy system using <tt class="docutils literal">system_load.py 10</tt> and <tt class="docutils literal">find /</tt> commands
running in other terminals:</p>
<pre class="literal-block">
$ python3 -m timeit 'sum(range(10**7))'
10 loops, best of 3: 372 msec per loop
</pre>
<p>The microbenchmark is 56% slower because of the high system load!</p>
<p>Result on the same busy system but using isolated CPUs. The <tt class="docutils literal">taskset</tt> command
allows to pin an application to specific CPUs:</p>
<pre class="literal-block">
$ taskset -c 1,3 python3 -m timeit 'sum(range(10**7))'
10 loops, best of 3: 230 msec per loop
</pre>
<p>Just to check, new run without CPU isolation:</p>
<pre class="literal-block">
$ python3 -m timeit 'sum(range(10**7))'
10 loops, best of 3: 357 msec per loop
</pre>
<p>The result with CPU isolation on a busy system is the same than the result an
idle system! CPU isolation removes most of the noise of the system.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Great job Linux!</p>
<p>Ok! Now, the benchmark is super stable, no? ...  Sorry, no, it's not stable yet.
I found a lot of other sources of &quot;noise&quot;.  We will see them in the following
articles ;-)</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://vstinner.readthedocs.org/">Victor Stinner's Notes</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/VictorStinner">Follow @VictorStinner on Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>